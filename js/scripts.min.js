$(function () {
	var $window = $(window);
	var $document = $(document);
	var $head = $(document.head);
	var $body = $(document.body);
	var zloInit = function () {
		// nanoscroller
		(function () {
			if (typeof $.fn.nanoScroller !== 'function') {
				return;
			}
			$('.nano').nanoScroller({preventPageScrolling: true});
		})();
		// slider
		(function () {
			if (typeof $.fn.slider !== 'function') {
				return;
			}
			$('.slider-simple').not('.slider-ready').each(function () {
				var $slider = $(this);
				var options = {
					'isKeyboard': true,
					'isFit': true,
					'margin': 22,
					'align': 0,
				};
				$slider.slider(options);
			});
		})();
	};
	var windowOpen = function (url, title, w, h) {
		if (window.name === title) {
			window.location.href = url;
			return window;
		}
		var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
		var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;
		var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
		var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;
		var left = ((width / 2) - (w / 2)) + dualScreenLeft;
		var top = ((height / 2) - (h / 2)) + dualScreenTop;
		var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
		if (window.focus) {
			newWindow.focus();
		}
		return newWindow;
	};

	// Кнопки class="changeclass" при нажатии вызывают addClass/removeClass/toggleClass для определённых селекторов
	$document.on('click', '.changeclass', function (event) {
		var $this = $(this);
		var selector;
		var action;
		var result = false;
		var data = $this.data('changeclass');
		if (typeof $this.data('changeclass-nopreventdefault') === 'undefined') {
			event.stopPropagation();
			event.preventDefault();
		}
		if (typeof data === 'object') {
			for (selector in data) {
				if (typeof data[selector] === 'object') {
					for (action in data[selector]) {
						switch (action) {
							case 'addClass':
								$(selector).addClass(data[selector][action]);
								result = true;
								break;
							case 'removeClass':
								$(selector).removeClass(data[selector][action]);
								result = true;
								break;
							case 'toggleClass':
								$(selector).toggleClass(data[selector][action]);
								result = true;
								break;
						}
					}
				}
			}
			if (result) {
				$window.trigger('resize');
			}
		}
	});

	// noanimation
	(function () {
		var classStopAnimation = "noanimation";
		$window.on('resize', function (event) {
			var $isAnimated = $('.js-animated');
			$isAnimated.addClass(classStopAnimation);
			$isAnimated.offset();
			$isAnimated.removeClass(classStopAnimation);
		});
	})();

	// Бургер-меню
	(function () {
		var isActive = $('.js-menu').hasClass('is_active');
		var toggle = function (newActive) {
			$('.js-menu').toggleClass('is_active', newActive);
			isActive = $('.js-menu').hasClass('is_active');
		};
		$('.js-burger').on('click', function (event) {
			event.preventDefault();
			toggle();
		});
		$window.on('resize', function (event) {
			if (isActive) {
				toggle(false);
			}
		});
		$document.on('keydown', function (event) {
			if (isActive && event.keyCode === 27 && !event.ctrlKey && !event.altKey && !event.shiftKey && !event.metaKey) {
				event.stopImmediatePropagation();
				toggle(false);
			}
		});
		$document.on('mousedown touchstart', function (event) {
			if (isActive) {
				toggle(false);
			}
		});
		$('.js-burger, .js-menu').on('mousedown touchstart', function (event) {
			event.stopPropagation();
		});
	})();

	// Диалоги
	(function () {
		var isOpen = false;
		var handlerKeydown = function (event) {
			if (event.keyCode === 27 && !event.ctrlKey && !event.altKey && !event.shiftKey && !event.metaKey) {
				event.stopImmediatePropagation();
				close();
			}
		};
		var handlerMousedown = function (event) {
			close();
		};
		var refresh = function () {
			$window.trigger('resize');
		};
		var open = function () {
			if (isOpen) {
				return;
			}
			var $dialog = $('.js-dialog.is_opened');
			var $dialogElements = $dialog.find('a, :input');
			$document.on('keydown', handlerKeydown);
			$document.on('mousedown touchstart', handlerMousedown);
			// safari IOS 11 hack to prevent wrong input cursor position - position: fixed; width: 100%
			$body.css({overflow: 'hidden',position: 'fixed',width: '100%'});
			$body.find('a, :enabled').not($dialogElements).each(function () {
				var $ele = $(this);
				var tabindex = $ele.attr('tabindex');
				if (typeof tabindex !== 'undefined') {
					$ele.data('dialog-tabindex', tabindex);
				}
				$ele.attr('tabindex', '-1');
				$ele.addClass('js-dialog-inert');
			});
			var $autofocus = $dialog.find('.js-dialog-autofocus').first();
			if (!$autofocus.length) {
				$autofocus = $dialog.find(':enabled[tabindex!="-1"]').first();
			}
			//$autofocus.focus().select();
			isOpen = true;
			refresh();
		};
		var close = function () {
			if (!isOpen) {
				return;
			}
			$('.js-dialog.is_opened').removeClass('is_opened');
			$document.off('keydown', handlerKeydown);
			$document.off('mousedown touchstart', handlerMousedown);
			$body.css({overflow: '',position: '',width: ''});
			$('.js-dialog-inert').each(function () {
				var $ele = $(this);
				var tabindex = $ele.data('dialog-tabindex');
				if (typeof tabindex !== 'undefined') {
					$ele.removeData('dialog-tabindex');
					$ele.attr('tabindex', tabindex);
				} else {
					$ele.removeAttr('tabindex');
				}
				$ele.removeClass('js-dialog-inert');
			});
			isOpen = false;
			refresh();
		};
		$document.on('click', '.js-dialog-open', function (event) {
			event.preventDefault();
			$($(this).data('dialog')).addClass('is_opened');
			open();
		});
		$document.on('mousedown touchstart', '.js-dialog-window', function (event) {
			event.stopPropagation();
		});
		$document.on('click', '.js-dialog-close', function (event) {
			event.stopPropagation();
			event.preventDefault();
			close();
		});
		$('.js-dialog.is_opened').each(function () {
			open();
		});
	})();

	// Кнопки «Купить», дублирующие основную
	$document.on('click', '.js-purchase-button', function (event) {
		event.preventDefault();
		$('.js-purchase-form').first().submit();
	});

	// Подсветка инпутов
	(function () {
		$('.field__input').on('input change', function (event) {
			var $input = $(this);
			var $field = $input.closest('.field');
			if ($input.val() !== '') {
				$field.addClass('field--not-empty');
				$field.removeClass('field--error');
			} else {
				$field.removeClass('field--not-empty');
			}
		});
	})();

	// Социальные сети
	(function () {
		var onClick = function (event) {
			if (event) {
				event.stopPropagation();
				event.preventDefault();
			}
			var $a = $(this);
			var $article = $a.closest('.js-article');
			var $data = ($article.length ? $article : $a);
			var href = '';
			var url = '';
			var metaUrl = '';
			var metaTitle = '';
			var metaDescription = '';
			var metaPicture = '';
			var dataNetwork = $a.data('share-network');
			var dataUrl = $data.data('share-url');
			var dataPicture = $data.data('share-picture');
			var dataTitle = $data.data('share-title');
			var dataDescription = $data.data('share-description');
			var truncate = function (s, n) {
				if (typeof s === 'string' && s.length > n) {
					s = s.slice(0, n) + '...';
				}
				return s;
			};
			var truncateTitle = function (s) {
				return truncate(s, 150);
			};
			var truncateDescription = function (s) {
				return truncate(s, 450);
			};
			var getQuery = function (params) {
				var parts = [];
				for (var i in params) {
					if (params[i]) {
						parts.push(i + '=' + encodeURIComponent(params[i]));
					}
				}
				return parts.join('&');
			};
			var getFullTitle = function () {
				return [dataTitle || metaTitle, dataDescription || metaDescription].join(' / ');
			};
			if (dataNetwork === '' && event) {
				$('.js-share-link').each(function () {
					var $a = $(this);
					var dataNetwork = $a.data('share-network');
					var isChanged = false;
					if (dataNetwork) {
						if (typeof dataUrl !== 'undefined') {
							$a.data('share-url', dataUrl);
							isChanged = true;
						}
						if (typeof dataPicture !== 'undefined') {
							$a.data('share-picture', dataPicture);
							isChanged = true;
						}
						if (typeof dataTitle !== 'undefined') {
							$a.data('share-title', dataTitle);
							isChanged = true;
						}
						if (typeof dataDescription !== 'undefined') {
							$a.data('share-description', dataDescription);
							isChanged = true;
						}
					}
					if (isChanged) {
						onClick.call(this);
					}
				});
			} else {
				if (dataNetwork) {
					metaUrl = $head.find('link[rel="canonical"]').prop('href') || $head.find('meta[property="og:url"]').prop('content') || '';
					metaTitle = $head.find('meta[property="og:title"]').prop('content') || '';
					metaDescription = $head.find('meta[property="og:description"]').prop('content') || '';
					metaPicture = $head.find('link[rel="image_src"]').prop('href') || '';
					url = dataUrl || metaUrl;
					switch (dataNetwork) {
						case 'fb':
							href = 'https://www.facebook.com/sharer/sharer.php?' + getQuery({
								'u': url
								/*
								'title': truncateTitle(dataTitle || metaTitle),
								'description': truncateDescription(dataDescription)
								*/
							});
							break;
						case 'vk':
							href = 'https://vk.com/share.php?' + getQuery({
								'url': url
								/*
								'image': dataPicture || metaPicture,
								'title': truncateDescription(getFullTitle()),
								'noparse': 'true'
								*/
							});
							break;
						case 'tg':
							href = 'https://t.me/share/url?' + getQuery({
								'url': url
								/*
								'text': truncateDescription(getFullTitle())
								*/
							});
							break;
					}
				}
				if (href) {
					this.href = href;
				}
				if (!event || event.ctrlKey || event.altKey || event.shiftKey || event.metaKey) {
					return;
				}
				if (href || this.href && $a.attr('href') !== '#') {
					windowOpen(href ? href : this.href, 'share', 800, 450);
				}
			}
		};
		$document.on('click', '.js-share-link', onClick);
		$('.js-share-link').each(function () {
			onClick.call(this);
		});
	})();

	// init
	(function () {
		zloInit();
		// Вызываем обработчики window.onResize
		$window.trigger('resize');
	})();
});
