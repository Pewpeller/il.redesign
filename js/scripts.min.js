$(function () {
	var $window = $(window);
	var $document = $(document);
	var $body = $(document.body);
	var zloInit = function () {
		// nanoscroller
		(function () {
			if (typeof $.fn.nanoScroller !== 'function') {
				return;
			}
			$('.nano').nanoScroller({preventPageScrolling: true});
		})();
		// slider
		(function () {
			if (typeof $.fn.slider !== 'function') {
				return;
			}
			$('.slider-simple').not('.slider-ready').each(function () {
				var $slider = $(this);
				var options = {
					'isKeyboard': true,
					'isFit': true,
					'margin': 22,
					'align': 0,
				};
				$slider.slider(options);
			});
		})();
	};

	// Кнопки class="changeclass" при нажатии вызывают addClass/removeClass/toggleClass для определённых селекторов
	$document.on('click', '.changeclass', function (event) {
		var $this = $(this);
		var selector;
		var action;
		var result = false;
		var data = $this.data('changeclass');
		if (typeof $this.data('changeclass-nopreventdefault') === 'undefined') {
			event.stopPropagation();
			event.preventDefault();
		}
		if (typeof data === 'object') {
			for (selector in data) {
				if (typeof data[selector] === 'object') {
					for (action in data[selector]) {
						switch (action) {
							case 'addClass':
								$(selector).addClass(data[selector][action]);
								result = true;
								break;
							case 'removeClass':
								$(selector).removeClass(data[selector][action]);
								result = true;
								break;
							case 'toggleClass':
								$(selector).toggleClass(data[selector][action]);
								result = true;
								break;
						}
					}
				}
			}
			if (result) {
				$window.trigger('resize');
			}
		}
	});

	// Бургер-меню
	(function () {
		var isActive = $('.js-menu').hasClass('is_active');
		var toggle = function (newActive) {
			$('.js-menu').toggleClass('is_active', newActive);
			isActive = $('.js-menu').hasClass('is_active');
		};
		$('.js-burger').on('click', function (event) {
			toggle();
		});
		$window.on('resize', function (event) {
			if (isActive) {
				toggle(false);
			}
		});
		$document.on('keydown', function (event) {
			if (isActive && event.keyCode === 27 && !event.ctrlKey && !event.altKey && !event.shiftKey && !event.metaKey) {
				event.stopImmediatePropagation();
				toggle(false);
			}
		});
		$document.on('mousedown touchstart', function (event) {
			if (isActive) {
				toggle(false);
			}
		});
		$('.js-burger, .js-menu').on('mousedown touchstart', function (event) {
			event.stopPropagation();
		});
	})();

	// Диалоги
	(function () {
		var isOpen = false;
		var handlerKeydown = function (event) {
			if (event.keyCode === 27 && !event.ctrlKey && !event.altKey && !event.shiftKey && !event.metaKey) {
				event.stopImmediatePropagation();
				close();
			}
		};
		var handlerMousedown = function (event) {
			close();
		};
		var refresh = function () {
			$window.trigger('resize');
		};
		var open = function () {
			if (isOpen) {
				return;
			}
			var $dialog = $('.js-dialog.is_opened');
			$document.on('keydown', handlerKeydown);
			$document.on('mousedown touchstart', handlerMousedown);
			$body.css({overflow: 'hidden'});
			$body.find('a, :enabled').not('.js-dialog a, .js-dialog :input').each(function () {
				var $ele = $(this);
				var tabindex = $ele.attr('tabindex');
				if (typeof tabindex !== 'undefined') {
					$ele.data('dialog-tabindex', tabindex);
				}
				$ele.attr('tabindex', '-1');
				$ele.addClass('js-dialog-inert');
			});
			$dialog.find('.js-dialog-autofocus').first().focus();
			isOpen = true;
			refresh();
		};
		var close = function () {
			if (!isOpen) {
				return;
			}
			$('.js-dialog.is_opened').removeClass('is_opened');
			$document.off('keydown', handlerKeydown);
			$document.off('mousedown touchstart', handlerMousedown);
			$body.css({overflow: ''});
			$('.js-dialog-inert').each(function () {
				var $ele = $(this);
				var tabindex = $ele.data('dialog-tabindex');
				if (typeof tabindex !== 'undefined') {
					$ele.removeData('dialog-tabindex');
					$ele.attr('tabindex', tabindex);
				} else {
					$ele.removeAttr('tabindex');
				}
				$ele.removeClass('js-dialog-inert');
			});
			isOpen = false;
			refresh();
		};
		$document.on('click', '.js-dialog-open', function (event) {
			event.preventDefault();
			$($(this).data('dialog')).addClass('is_opened');
			open();
		});
		$document.on('mousedown touchstart', '.js-dialog-window', function (event) {
			event.stopPropagation();
		});
		$document.on('click', '.js-dialog-close', function (event) {
			event.stopPropagation();
			event.preventDefault();
			close();
		});
		$('.js-dialog.is_opened').each(function () {
			open();
		});
	})();

	// Кнопки «Купить», дублирующие основную
	$document.on('click', '.js-purchase-button', function (event) {
		$('.js-purchase-form').first().submit();
	});

	// Подсветка инпутов
	(function () {
		$('.field__input').on('input change', function (event) {
			var $input = $(this);
			var $field = $input.closest('.field');
			if ($input.val() !== '') {
				$field.addClass('field--not-empty');
				$field.removeClass('field--error');
			} else {
				$field.removeClass('field--not-empty');
			}
		});
	})();

	// init
	(function () {
		zloInit();
		// Вызываем обработчики window.onResize
		$window.trigger('resize');
	})();
});
